<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meal Genius</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>Meal Genius</h1>
        <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
    </header>

    <section id="biometrics">
        <h2>Step 1: Enter Your Biometrics</h2>
        <form id="biometricForm">
            <label>Age: <input type="number" name="age" required min="1" max="120"></label><br><br>
            <label>Weight (lbs): <input type="number" name="weight" required min="50" max="500"></label><br><br>
            <label>Height (cm): <input type="number" name="height" required min="100" max="250"></label><br><br>
            <label>Gender:
                <select name="gender" required>
                    <option value="">Select</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                </select>
            </label><br><br>
            <label>Activity Level:
                <select name="activity" required>
                    <option value="">Select</option>
                    <option value="sedentary">Sedentary</option>
                    <option value="light">Lightly Active</option>
                    <option value="moderate">Moderately Active</option>
                    <option value="active">Very Active</option>
                </select>
            </label><br><br>
            <button type="button" id="nextToPreferences" onclick="validateAndProceed('preferences')" disabled>Next</button>
        </form>
    </section>

    <section id="preferences" style="display:none;">
        <h2>Step 2: Food Preferences and Budget</h2>
        <form id="preferencesForm">
            <label>Diet Type:
                <select name="diet" required>
                    <option value="">Select</option>
                    <option value="omnivore">Omnivore</option>
                    <option value="vegetarian">Vegetarian</option>
                    <option value="vegan">Vegan</option>
                    <option value="keto">Keto</option>
                    <option value="paleo">Paleo</option>
                </select>
            </label><br><br>
            <label>Allergies (comma separated): <input type="text" name="allergies"></label><br><br>
            <label>Food Likes (comma separated): <input type="text" name="likes"></label><br><br>
            <label>Food Dislikes (comma separated): <input type="text" name="dislikes"></label><br><br>
            <label>Budget (per week in $): <input type="number" name="budget" required min="20" max="1000"></label><br><br>
            <button type="button" onclick="showStep('biometrics')">Back</button>
            <button type="button" id="nextToRecommendations" onclick="validateAndProceed('recommendations')" disabled>Get Meal Plan</button>
        </form>
    </section>

    <section id="recommendations" style="display:none;">
        <h2>Step 3: Your AI Meal Plan</h2>
        <div id="loadingSpinner" style="display: none;">
            <div class="spinner"></div>
            <p>Generating your personalized plan...</p>
        </div>
        <div id="mealPlanContent" style="display: none;"></div>
        <button type="button" onclick="showStep('preferences')">Back</button>
        <button type="button" id="regenerateButton" onclick="regenerateMealPlan()" style="display: none;">Regenerate</button>
    </section>

    <footer>
        <p>&copy; 2025 Meal Genius. All rights reserved.</p>
    </footer>

    <script>
    let currentUserData = null;

    function showStep(step) {
        document.getElementById('biometrics').style.display = 'none';
        document.getElementById('preferences').style.display = 'none';
        document.getElementById('recommendations').style.display = 'none';

        document.getElementById(step).style.display = 'block';

        const progressBar = document.getElementById('progressBar');
        if (step === 'biometrics') {
            progressBar.style.width = '33%';
        } else if (step === 'preferences') {
            progressBar.style.width = '66%';
        } else if (step === 'recommendations') {
            progressBar.style.width = '100%';
        }
    }

    function validateAndProceed(step) {
        if (step === 'preferences' && !validateBiometrics()) {
            return;
        }
        if (step === 'recommendations' && !validatePreferences()) {
            return;
        }
        if (step === 'recommendations') {
            currentUserData = collectUserData();
            generateMealPlan();
        } else {
            showStep(step);
        }
    }

    function validateBiometrics() {
        const form = document.getElementById('biometricForm');
        const age = parseInt(form.age.value);
        const weight = parseInt(form.weight.value);
        const height = parseInt(form.height.value);

        if (isNaN(age) || age < 1 || age > 120) {
            alert('Please enter a valid age between 1 and 120');
            return false;
        }
        if (isNaN(weight) || weight < 50 || weight > 500) {
            alert('Please enter a valid weight between 50 and 500 lbs');
            return false;
        }
        if (isNaN(height) || height < 100 || height > 250) {
            alert('Please enter a valid height between 100 and 250 cm');
            return false;
        }
        if (!form.gender.value) {
            alert('Please select your gender');
            return false;
        }
        if (!form.activity.value) {
            alert('Please select your activity level');
            return false;
        }
        return true;
    }

    function validatePreferences() {
        const form = document.getElementById('preferencesForm');
        const budget = parseInt(form.budget.value);

        if (!form.diet.value) {
            alert('Please select your diet type');
            return false;
        }
        if (isNaN(budget) || budget < 20 || budget > 1000) {
            alert('Please enter a valid budget between $20 and $1000');
            return false;
        }
        return true;
    }

    function collectUserData() {
        const biometricForm = document.getElementById('biometricForm');
        const preferencesForm = document.getElementById('preferencesForm');

        return {
            age: biometricForm.age.value,
            weight: biometricForm.weight.value,
            height: biometricForm.height.value,
            gender: biometricForm.gender.value,
            activity: biometricForm.activity.value,
            diet: preferencesForm.diet.value,
            allergies: preferencesForm.allergies.value,
            likes: preferencesForm.likes.value,
            dislikes: preferencesForm.dislikes.value,
            budget: preferencesForm.budget.value,
        };
    }

    async function generateMealPlan() {
        showStep('recommendations');
        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('mealPlanContent').style.display = 'none';
        document.getElementById('regenerateButton').style.display = 'none';

        try {
            const apiUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                ? 'http://localhost:5000/generate-meal'
                : '/generate-meal';

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(currentUserData)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || `Server error: ${response.status}`);
            }

            const data = await response.json();

            if (!data.mealPlan) {
                throw new Error('No meal plan received from server');
            }

            displayMealPlan(data.mealPlan);
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('mealPlanContent').innerHTML = `
                <div class="error-message">
                    <p>Failed to generate meal plan:</p>
                    <p>${error.message}</p>
                    <p>Please try again later.</p>
                </div>
            `;
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('mealPlanContent').style.display = 'block';
            document.getElementById('regenerateButton').style.display = 'block';
        }
    }

    function displayMealPlan(mealPlan) {
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('mealPlanContent').style.display = 'block';
        document.getElementById('regenerateButton').style.display = 'block';

        const formattedPlan = mealPlan
            .replace(/\n/g, '<br>')
            .replace(/(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday):/g, '<strong>$1:</strong>');

        document.getElementById('mealPlanContent').innerHTML = `
            <div class="meal-plan">
                ${formattedPlan}
            </div>
        `;
    }

    function regenerateMealPlan() {
        if (currentUserData) {
            generateMealPlan();
        } else {
            showStep('biometrics');
        }
    }

    function setupFormValidation() {
        const biometricForm = document.getElementById('biometricForm');
        const preferencesForm = document.getElementById('preferencesForm');

        biometricForm.addEventListener('input', () => {
            const allFilled = Array.from(biometricForm.elements).every(input => {
                if (input.hasAttribute('required')) {
                    return input.value.trim() !== '';
                }
                return true;
            });
            document.getElementById('nextToPreferences').disabled = !allFilled;
        });

        preferencesForm.addEventListener('input', () => {
            const allFilled = Array.from(preferencesForm.elements).every(input => {
                if (input.hasAttribute('required')) {
                    return input.value.trim() !== '';
                }
                return true;
            });
            document.getElementById('nextToRecommendations').disabled = !allFilled;
        });
    }

    window.onload = function() {
        showStep('biometrics');
        setupFormValidation();
    };
    </script>
</body>
</html>
